apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.cluster.name }}-config
  namespace: {{ .Values.cluster.namespace }}
data:
  postgresql.conf: |
    # Network Configuration
    listen_addresses = '*'
    port = 5432
    
    # Connection and Authentication
    max_connections = {{ .Values.postgresConfig.maxConnections }}
    
    # Memory Configuration
    shared_buffers = {{ .Values.postgresConfig.sharedBuffers }}
    effective_cache_size = {{ .Values.postgresConfig.effectiveCacheSize }}
    maintenance_work_mem = {{ .Values.postgresConfig.maintenanceWorkMem }}
    wal_buffers = {{ .Values.postgresConfig.walBuffers }}
    work_mem = {{ .Values.postgresConfig.workMem }}
    
    # WAL and Checkpoint Configuration
    max_wal_size = {{ .Values.postgresConfig.maxWalSize }}
    min_wal_size = {{ .Values.postgresConfig.minWalSize }}
    checkpoint_timeout = {{ .Values.postgresConfig.checkpointTimeout }}
    checkpoint_completion_target = {{ .Values.postgresConfig.checkpointCompletionTarget }}
    
    # Logging (minimal logging to save space)
    log_destination = 'stderr'
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_size = '10MB'
    log_rotation_age = '1d'
    log_truncate_on_rotation = on
    log_min_duration_statement = {{ .Values.postgresConfig.logMinDurationStatement }}
    log_autovacuum_min_duration = {{ .Values.postgresConfig.logAutovacuumMinDuration }}
    log_statement = 'none'
    
    # Autovacuum settings for small instances
    autovacuum = on
    autovacuum_max_workers = 1
    autovacuum_naptime = '30s'
    autovacuum_vacuum_scale_factor = 0.1
    autovacuum_analyze_scale_factor = 0.05
